{% extends "base.html" %}

{% block title %}–°—Ö–µ–º–∞ –∑–∞–ª–∞{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1 class="page-title">–°—Ö–µ–º–∞ –∑–∞–ª–∞</h1>
    <a href="/cashier/sales" style="color: white; text-decoration: none;">‚Üê –ö —Å–µ–∞–Ω—Å–∞–º</a>
</div>

<div id="sessionInfo" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 16px; margin-bottom: 20px; color: white;">
    –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ–∞–Ω—Å–µ...
</div>

<div class="hall-scheme" id="hallScheme">
    <div class="screen">–≠–ö–†–ê–ù</div>
    <div class="seats-grid" id="seatsGrid">
        <!-- –ú–µ—Å—Ç–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ API -->
    </div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #e0e0e0;"></div>
            <span>–°—Ç–∞–Ω–¥–∞—Ä—Ç</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffd700;"></div>
            <span>VIP</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff6b6b;"></div>
            <span>–ü—Ä–µ–º–∏—É–º</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #666;"></div>
            <span>–ó–∞–Ω—è—Ç–æ</span>
        </div>
    </div>
    
    <div class="legend">
        <div class="legend-item">
            <span>1-3 —Ä—è–¥—ã - –ü—Ä–µ–º–∏—É–º</span>
        </div>
        <div class="legend-item">
            <span>4-6 —Ä—è–¥—ã - VIP</span>
        </div>
        <div class="legend-item">
            <span>7-10 —Ä—è–¥—ã - –°—Ç–∞–Ω–¥–∞—Ä—Ç</span>
        </div>
    </div>
</div>

<div id="selectedSeatInfo" style="background: white; padding: 20px; border-radius: 16px; margin-top: 20px; display: none;">
    <h3>–í—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ:</h3>
    <p id="selectedSeatText"></p>
    <button onclick="goToCheckout()" class="btn btn-add">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</button>
</div>

<script>
    const sessionId = window.location.pathname.split('/').pop();
    let sessionData = null;
    let soldSeats = [];
    let selectedSeat = null;
    
    document.addEventListener('DOMContentLoaded', async function() {
        await loadSessionData();
        await loadSoldTickets();
        await loadSeats();
    });
    
    async function loadSessionData() {
        try {
            sessionData = await apiCall(`/api/session/${sessionId}`);
            document.getElementById('sessionInfo').innerHTML = `
                <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–π —Å–µ–∞–Ω—Å:</h3>
                <p>üìÖ ${sessionData.date} | ${sessionData.movie} | ${sessionData.start_time} - ${sessionData.end_time} | –ó–∞–ª ${sessionData.hall}</p>
                <p>üí∞ –¶–µ–Ω–∞: ${sessionData.price} ‚ÇΩ (${sessionData.tariff_name})</p>
            `;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∞–Ω—Å–∞:', error);
        }
    }
    
    async function loadSoldTickets() {
        try {
            const tickets = await apiCall(`/api/tickets/${sessionId}`);
            soldSeats = tickets.map(t => t.seat_id);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤:', error);
        }
    }
    
    async function loadSeats() {
        if (!sessionData) return;
        
        try {
            const seats = await apiCall(`/api/seats/${sessionData.hall_id}`);
            const grid = document.getElementById('seatsGrid');
            grid.innerHTML = '';
            
            let currentRow = 0;
            let rowDiv = null;
            
            seats.forEach(seat => {
                if (seat.row !== currentRow) {
                    if (rowDiv) grid.appendChild(rowDiv);
                    currentRow = seat.row;
                    rowDiv = document.createElement('div');
                    rowDiv.className = 'seat-row';
                }
                
                const isSold = soldSeats.includes(seat.id);
                const seatClass = getSeatClass(seat.type, isSold);
                
                const seatDiv = document.createElement('div');
                seatDiv.className = `seat ${seatClass}`;
                seatDiv.dataset.seatId = seat.id;
                seatDiv.dataset.row = seat.row;
                seatDiv.dataset.seat = seat.seat;
                seatDiv.dataset.type = seat.type;
                if (isSold) seatDiv.dataset.sold = 'true';
                seatDiv.textContent = seat.seat;
                seatDiv.onclick = () => selectSeat(seatDiv);
                
                rowDiv.appendChild(seatDiv);
            });
            
            if (rowDiv) grid.appendChild(rowDiv);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Å—Ç:', error);
        }
    }
    
    function getSeatClass(type, isSold) {
        if (isSold) return 'sold';
        switch(type) {
            case '–°—Ç–∞–Ω–¥–∞—Ä—Ç': return 'standard';
            case 'VIP': return 'vip';
            case '–ü—Ä–µ–º–∏—É–º': return 'premium';
            default: return 'standard';
        }
    }
    
    function selectSeat(element) {
        if (element.dataset.sold === 'true') {
            alert('–≠—Ç–æ –º–µ—Å—Ç–æ —É–∂–µ –∑–∞–Ω—è—Ç–æ');
            return;
        }
        
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—Ç–∞
        if (selectedSeat) {
            selectedSeat.classList.remove('selected');
        }
        
        // –í—ã–¥–µ–ª—è–µ–º –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ
        element.classList.add('selected');
        selectedSeat = element;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        document.getElementById('selectedSeatText').textContent = 
            `–†—è–¥: ${element.dataset.row} –ú–µ—Å—Ç–æ: ${element.dataset.seat} (${element.dataset.type})`;
        document.getElementById('selectedSeatInfo').style.display = 'block';
    }
    
    function goToCheckout() {
        if (!selectedSeat) return;
        window.location.href = `/cashier/checkout?session_id=${sessionId}&seat_id=${selectedSeat.dataset.seatId}`;
    }
</script>
{% endblock %}