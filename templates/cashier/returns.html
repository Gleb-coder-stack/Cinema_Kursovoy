{% extends "base.html" %}

{% block title %}Возврат билетов{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1 class="page-title">Возврат билетов</h1>
    <a href="/cashier" style="color: white; text-decoration: none;">← Главная</a>
</div>

<div style="margin-bottom: 30px;">
    <h3 style="color: white; margin-bottom: 10px;">Поиск по сеансу:</h3>
    <select id="sessionSelect" style="padding: 10px; border-radius: 8px; width: 100%; max-width: 500px;">
        <option value="">Выберите сеанс</option>
    </select>
</div>

<div id="ticketsList" style="display: none;">
    <h3 style="color: white; margin: 20px 0;">Список билетов</h3>
    <table>
        <thead>
            <tr>
                <th>ФИО</th>
                <th>Ряд</th>
                <th>Место</th>
                <th>Цена</th>
                <th>Действие</th>
            </tr>
        </thead>
        <tbody id="ticketsBody">
        </tbody>
    </table>
</div>

<script>
    let sessions = [];
    let currentTickets = [];
    
    document.addEventListener('DOMContentLoaded', async function() {
        await loadSessions();
    });
    
    async function loadSessions() {
        try {
            sessions = await apiCall('/api/sessions');
            const select = document.getElementById('sessionSelect');
            
            sessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.id;
                option.textContent = `${session.date} | ${session.movie} | ${session.start_time} | Зал ${session.hall}`;
                select.appendChild(option);
            });
            
            select.addEventListener('change', onSessionChange);
        } catch (error) {
            console.error('Ошибка загрузки сеансов:', error);
        }
    }
    
    async function onSessionChange(e) {
        const sessionId = e.target.value;
        if (!sessionId) {
            document.getElementById('ticketsList').style.display = 'none';
            return;
        }
        
        try {
            const tickets = await apiCall(`/api/tickets/${sessionId}`);
            currentTickets = tickets;
            displayTickets(tickets);
        } catch (error) {
            console.error('Ошибка загрузки билетов:', error);
        }
    }
    
    function displayTickets(tickets) {
        const tbody = document.getElementById('ticketsBody');
        tbody.innerHTML = '';
        
        tickets.forEach(ticket => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${ticket.customer_name}</td>
                <td>${ticket.row}</td>
                <td>${ticket.seat}</td>
                <td>${ticket.price} ₽</td>
                <td>
                    <button onclick="returnTicket(${ticket.id})" class="btn btn-delete">Возврат</button>
                </td>
            `;
        });
        
        document.getElementById('ticketsList').style.display = 'block';
    }
    
    async function returnTicket(ticketId) {
        if (confirm('Оформить возврат билета?')) {
            try {
                const result = await apiCall(`/api/tickets/return/${ticketId}`, 'POST');
                if (result.success) {
                    alert('Возврат оформлен');
                    // Обновляем список билетов
                    const sessionId = document.getElementById('sessionSelect').value;
                    const tickets = await apiCall(`/api/tickets/${sessionId}`);
                    displayTickets(tickets);
                } else {
                    alert('Ошибка при оформлении возврата');
                }
            } catch (error) {
                alert('Ошибка при оформлении возврата');
            }
        }
    }
</script>
{% endblock %}